<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>多数据源演示系统</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .header h1 {
            color: #2c3e50;
            margin-bottom: 10px;
        }
        .container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        @media (max-width: 768px) {
            .container {
                grid-template-columns: 1fr;
            }
        }
        .card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .card h3 {
            color: #34495e;
            margin-top: 0;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .form-group input, .form-group textarea, .form-group select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        .form-group textarea {
            height: 100px;
            resize: vertical;
        }
        .btn {
            background-color: #3498db;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }
        .btn:hover {
            background-color: #2980b9;
        }
        .btn-block {
            display: block;
            width: 100%;
        }
        .result {
            margin-top: 15px;
            padding: 10px;
            border-radius: 4px;
            display: none;
        }
        .result.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .result.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .section-title {
            grid-column: 1 / -1;
            text-align: center;
        }
        .section-title h2 {
            color: #2c3e50;
            margin: 0;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>多数据源演示系统</h1>
        <p>本系统演示了在Spring Boot中动态管理多个数据源和Redis集群的功能</p>
    </div>

    <div class="container">
        <div class="section-title">
            <h2>数据源管理</h2>
        </div>

        <!-- 添加数据源 -->
        <div class="card">
            <h3>添加数据源</h3>
            <form id="addDataSourceForm">
                <div class="form-group">
                    <label for="dsName">数据源名称:</label>
                    <input type="text" id="dsName" name="dsName" required>
                </div>
                <div class="form-group">
                    <label for="url">数据库URL:</label>
                    <input type="text" id="url" name="url" value="jdbc:h2:mem:testdb" required>
                </div>
                <div class="form-group">
                    <label for="username">用户名:</label>
                    <input type="text" id="username" name="username" value="sa" required>
                </div>
                <div class="form-group">
                    <label for="password">密码:</label>
                    <input type="password" id="password" name="password" value="">
                </div>
                <div class="form-group">
                    <label for="driverClassName">驱动类:</label>
                    <input type="text" id="driverClassName" name="driverClassName" value="org.h2.Driver" required>
                </div>
                <div class="form-group">
                    <label for="initialSize">初始连接数:</label>
                    <input type="number" id="initialSize" name="initialSize" value="5">
                </div>
                <div class="form-group">
                    <label for="minIdle">最小空闲连接:</label>
                    <input type="number" id="minIdle" name="minIdle" value="5">
                </div>
                <div class="form-group">
                    <label for="maxActive">最大活跃连接:</label>
                    <input type="number" id="maxActive" name="maxActive" value="20">
                </div>
                <div class="form-group">
                    <label for="maxWait">最大等待时间(ms):</label>
                    <input type="number" id="maxWait" name="maxWait" value="60000">
                </div>
                <button type="submit" class="btn btn-block">添加数据源</button>
            </form>
            <div id="addDataSourceResult" class="result"></div>
        </div>

        <!-- 数据源操作 -->
        <div class="card">
            <h3>数据源操作</h3>
            <div class="form-group">
                <label for="dataSourceList">数据源列表:</label>
                <select id="dataSourceList"></select>
                <button id="refreshDataSources" class="btn">刷新列表</button>
            </div>
            <div class="form-group">
                <button id="listDataSources" class="btn btn-block">查询所有数据源</button>
            </div>
            <div class="form-group">
                <button id="switchDataSource" class="btn btn-block">切换到选中数据源</button>
            </div>
            <div class="form-group">
                <button id="removeDataSource" class="btn btn-block">删除选中数据源</button>
            </div>
            <div id="dataSourceOperationResult" class="result"></div>
        </div>

        <div class="section-title">
            <h2>表管理</h2>
        </div>

        <!-- 创建表 -->
        <div class="card">
            <h3>创建表</h3>
            <form id="createTableForm">
                <div class="form-group">
                    <label for="tableDsName">数据源名称:</label>
                    <input type="text" id="tableDsName" name="tableDsName" required>
                </div>
                <div class="form-group">
                    <label for="tableName">表名:</label>
                    <input type="text" id="tableName" name="tableName" required>
                </div>
                <div class="form-group">
                    <label for="createTableSql">创建表SQL:</label>
                    <textarea id="createTableSql" name="createTableSql" required>CREATE TABLE users (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    name VARCHAR(255) NOT NULL,
    email VARCHAR(255) NOT NULL
)</textarea>
                </div>
                <button type="submit" class="btn btn-block">创建表</button>
            </form>
            <div id="createTableResult" class="result"></div>
        </div>

        <!-- 表操作 -->
        <div class="card">
            <h3>表操作</h3>
            <div class="form-group">
                <label for="tableListDsName">数据源名称:</label>
                <input type="text" id="tableListDsName" name="tableListDsName" required>
            </div>
            <div class="form-group">
                <button id="listTables" class="btn btn-block">查询表列表</button>
            </div>
            <div class="form-group">
                <label for="dropTableName">要删除的表名:</label>
                <input type="text" id="dropTableName" name="dropTableName" required>
            </div>
            <div class="form-group">
                <button id="dropTable" class="btn btn-block">删除表</button>
            </div>
            <div id="tableOperationResult" class="result"></div>
        </div>

        <div class="section-title">
            <h2>用户数据操作</h2>
        </div>

        <!-- 添加用户 -->
        <div class="card">
            <h3>添加用户</h3>
            <form id="addUserForm">
                <div class="form-group">
                    <label for="userDsName">数据源名称:</label>
                    <input type="text" id="userDsName" name="userDsName" required>
                </div>
                <div class="form-group">
                    <label for="userName">用户名:</label>
                    <input type="text" id="userName" name="userName" required>
                </div>
                <div class="form-group">
                    <label for="userEmail">邮箱:</label>
                    <input type="email" id="userEmail" name="userEmail" required>
                </div>
                <button type="submit" class="btn btn-block">添加用户</button>
            </form>
            <div id="addUserResult" class="result"></div>
        </div>

        <!-- 查询用户 -->
        <div class="card">
            <h3>查询用户</h3>
            <div class="form-group">
                <label for="queryUserDsName">数据源名称:</label>
                <input type="text" id="queryUserDsName" name="queryUserDsName" required>
            </div>
            <div class="form-group">
                <button id="queryUsers" class="btn btn-block">查询所有用户</button>
            </div>
            <div id="queryUsersResult" class="result"></div>
        </div>

        <div class="section-title">
            <h2>Redis集群管理</h2>
        </div>

        <!-- 添加Redis集群 -->
        <div class="card">
            <h3>添加Redis集群</h3>
            <form id="addRedisForm">
                <div class="form-group">
                    <label for="redisDsName">数据源名称:</label>
                    <input type="text" id="redisDsName" name="redisDsName" required>
                </div>
                <div class="form-group">
                    <label for="redisHost">Redis主机:</label>
                    <input type="text" id="redisHost" name="redisHost" value="localhost" required>
                </div>
                <div class="form-group">
                    <label for="redisPort">Redis端口:</label>
                    <input type="number" id="redisPort" name="redisPort" value="6379" required>
                </div>
                <button type="submit" class="btn btn-block">添加Redis集群</button>
            </form>
            <div id="addRedisResult" class="result"></div>
        </div>

        <!-- Redis操作 -->
        <div class="card">
            <h3>Redis操作</h3>
            <div class="form-group">
                <label for="redisOpsDsName">数据源名称:</label>
                <input type="text" id="redisOpsDsName" name="redisOpsDsName" required>
            </div>
            <div class="form-group">
                <label for="redisKey">键:</label>
                <input type="text" id="redisKey" name="redisKey" required>
                <label for="redisValue">值:</label>
                <input type="text" id="redisValue" name="redisValue">
            </div>
            <div class="form-group">
                <button id="setRedis" class="btn">设置键值</button>
                <button id="getRedis" class="btn">获取值</button>
            </div>
            <div class="form-group">
                <button id="listRedis" class="btn btn-block">查询Redis集群列表</button>
            </div>
            <div id="redisOperationResult" class="result"></div>
        </div>
    </div>

    <script>
        // 全局变量
        const baseUrl = '';

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 绑定事件
            bindEvents();
            
            // 初始化数据源列表
            refreshDataSources();
        });

        // 绑定事件
        function bindEvents() {
            // 数据源管理事件
            document.getElementById('addDataSourceForm').addEventListener('submit', addDataSource);
            document.getElementById('refreshDataSources').addEventListener('click', refreshDataSources);
            document.getElementById('listDataSources').addEventListener('click', listDataSources);
            document.getElementById('switchDataSource').addEventListener('click', switchDataSource);
            document.getElementById('removeDataSource').addEventListener('click', removeDataSource);
            
            // 表管理事件
            document.getElementById('createTableForm').addEventListener('submit', createTable);
            document.getElementById('listTables').addEventListener('click', listTables);
            document.getElementById('dropTable').addEventListener('click', dropTable);
            
            // 用户操作事件
            document.getElementById('addUserForm').addEventListener('submit', addUser);
            document.getElementById('queryUsers').addEventListener('click', queryUsers);
            
            // Redis操作事件
            document.getElementById('addRedisForm').addEventListener('submit', addRedis);
            document.getElementById('setRedis').addEventListener('click', setRedisValue);
            document.getElementById('getRedis').addEventListener('click', getRedisValue);
            document.getElementById('listRedis').addEventListener('click', listRedisClusters);
        }

        // 显示结果
        function showResult(elementId, success, message) {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.className = 'result ' + (success ? 'success' : 'error');
            element.style.display = 'block';
            
            // 3秒后自动隐藏
            setTimeout(() => {
                element.style.display = 'none';
            }, 3000);
        }

        // 添加数据源
        function addDataSource(event) {
            event.preventDefault();
            
            const formData = new FormData(document.getElementById('addDataSourceForm'));
            
            fetch(baseUrl + '/api/datasource/add', {
                method: 'POST',
                body: new URLSearchParams(formData)
            })
            .then(response => response.json())
            .then(data => {
                showResult('addDataSourceResult', data.success, data.message);
                if (data.success) {
                    document.getElementById('addDataSourceForm').reset();
                    refreshDataSources(); // 刷新数据源列表
                }
            })
            .catch(error => {
                showResult('addDataSourceResult', false, '添加数据源失败: ' + error);
            });
        }

        // 刷新数据源列表
        function refreshDataSources() {
            fetch(baseUrl + '/api/datasource/list')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // 获取所有需要更新的下拉列表元素
                    const dataSourceList = document.getElementById('dataSourceList');
                    const redisDsName = document.getElementById('redisDsName');
                    const userDsName = document.getElementById('userDsName');
                    const queryUserDsName = document.getElementById('queryUserDsName');
                    const redisOpDsName = document.getElementById('redisOpDsName');
                    const tableDsName = document.getElementById('tableDsName');
                    const tableListDsName = document.getElementById('tableListDsName');
                    
                    // 清空现有选项
                    dataSourceList.innerHTML = '';
                    redisDsName.innerHTML = '';
                    userDsName.innerHTML = '';
                    queryUserDsName.innerHTML = '';
                    redisOpDsName.innerHTML = '';
                    tableDsName.innerHTML = '';
                    tableListDsName.innerHTML = '';
                    
                    // 添加新选项
                    data.dataSources.forEach(dsName => {
                        const option = document.createElement('option');
                        option.value = dsName;
                        option.textContent = dsName;
                        
                        dataSourceList.appendChild(option.cloneNode(true));
                        redisDsName.appendChild(option.cloneNode(true));
                        userDsName.appendChild(option.cloneNode(true));
                        queryUserDsName.appendChild(option.cloneNode(true));
                        redisOpDsName.appendChild(option.cloneNode(true));
                        tableDsName.appendChild(option.cloneNode(true));
                        tableListDsName.appendChild(option.cloneNode(true));
                    });
                } else {
                    showResult('dataSourceOperationResult', false, data.message);
                }
            })
            .catch(error => {
                showResult('dataSourceOperationResult', false, '获取数据源列表失败: ' + error);
            });
        }

        // 查询所有数据源
        function listDataSources() {
            fetch(baseUrl + '/api/datasource/list')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    let message = '数据源列表: \n';
                    data.dataSources.forEach(dsName => {
                        message += '- ' + dsName + '\n';
                    });
                    showResult('dataSourceOperationResult', true, message);
                } else {
                    showResult('dataSourceOperationResult', false, data.message);
                }
            })
            .catch(error => {
                showResult('dataSourceOperationResult', false, '查询数据源列表失败: ' + error);
            });
        }

        // 切换数据源
        function switchDataSource() {
            const dsName = document.getElementById('dataSourceList').value;
            
            if (!dsName) {
                showResult('dataSourceOperationResult', false, '请选择一个数据源');
                return;
            }
            
            fetch(baseUrl + '/api/datasource/switch?dsName=' + encodeURIComponent(dsName), {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                showResult('dataSourceOperationResult', data.success, data.message);
            })
            .catch(error => {
                showResult('dataSourceOperationResult', false, '切换数据源失败: ' + error);
            });
        }

        // 删除数据源
        function removeDataSource() {
            const dsName = document.getElementById('dataSourceList').value;
            
            if (!dsName) {
                showResult('dataSourceOperationResult', false, '请选择一个数据源');
                return;
            }
            
            if (!confirm('确定要删除数据源 ' + dsName + ' 吗？')) {
                return;
            }
            
            fetch(baseUrl + '/api/datasource/remove?dsName=' + encodeURIComponent(dsName), {
                method: 'DELETE'
            })
            .then(response => response.json())
            .then(data => {
                showResult('dataSourceOperationResult', data.success, data.message);
                if (data.success) {
                    refreshDataSources(); // 刷新数据源列表
                }
            })
            .catch(error => {
                showResult('dataSourceOperationResult', false, '删除数据源失败: ' + error);
            });
        }

        // 创建表
        function createTable(event) {
            event.preventDefault();
            
            const dsName = document.getElementById('tableDsName').value;
            const tableName = document.getElementById('tableName').value;
            const sql = document.getElementById('createTableSql').value;
            
            if (!dsName || !tableName || !sql) {
                showResult('createTableResult', false, '请填写所有字段');
                return;
            }
            
            const params = new URLSearchParams();
            params.append('tableName', tableName);
            params.append('sql', sql);
            
            fetch(baseUrl + '/api/datasource/' + encodeURIComponent(dsName) + '/table/create', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
                body: params
            })
            .then(response => response.json())
            .then(data => {
                showResult('createTableResult', data.success, data.message);
            })
            .catch(error => {
                showResult('createTableResult', false, '创建表失败: ' + error);
            });
        }

        // 查询表列表
        function listTables() {
            const dsName = document.getElementById('tableListDsName').value;
            
            if (!dsName) {
                showResult('tableOperationResult', false, '请填写数据源名称');
                return;
            }
            
            fetch(baseUrl + '/api/datasource/' + encodeURIComponent(dsName) + '/table/list')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    let message = '表列表: \n';
                    if (data.tables && data.tables.length > 0) {
                        data.tables.forEach(table => {
                            // 表名可能在不同的键中，根据数据库类型而定
                            const tableName = table.TABLE_NAME || table.table_name || JSON.stringify(table);
                            message += '- ' + tableName + '\n';
                        });
                    } else {
                        message += '无表\n';
                    }
                    showResult('tableOperationResult', true, message);
                } else {
                    showResult('tableOperationResult', false, data.message);
                }
            })
            .catch(error => {
                showResult('tableOperationResult', false, '查询表列表失败: ' + error);
            });
        }

        // 删除表
        function dropTable() {
            const dsName = document.getElementById('tableListDsName').value;
            const tableName = document.getElementById('dropTableName').value;
            
            if (!dsName || !tableName) {
                showResult('tableOperationResult', false, '请填写数据源名称和表名');
                return;
            }
            
            if (!confirm('确定要删除表 ' + tableName + ' 吗？')) {
                return;
            }
            
            fetch(baseUrl + '/api/datasource/' + encodeURIComponent(dsName) + '/table/drop?tableName=' + encodeURIComponent(tableName), {
                method: 'DELETE'
            })
            .then(response => response.json())
            .then(data => {
                showResult('tableOperationResult', data.success, data.message);
            })
            .catch(error => {
                showResult('tableOperationResult', false, '删除表失败: ' + error);
            });
        }

        // 添加用户
        function addUser(event) {
            event.preventDefault();
            
            const dsName = document.getElementById('userDsName').value;
            const name = document.getElementById('userName').value;
            const email = document.getElementById('userEmail').value;
            
            if (!dsName || !name || !email) {
                showResult('addUserResult', false, '请填写所有字段');
                return;
            }
            
            const userData = {
                name: name,
                email: email
            };
            
            fetch(baseUrl + '/api/datasource/' + encodeURIComponent(dsName) + '/users', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(userData)
            })
            .then(response => response.json())
            .then(data => {
                showResult('addUserResult', data.success !== undefined ? data.success : true, 
                          data.message || (data.name ? '用户添加成功: ' + data.name : '操作完成'));
            })
            .catch(error => {
                showResult('addUserResult', false, '添加用户失败: ' + error);
            });
        }

        // 查询用户
        function queryUsers() {
            const dsName = document.getElementById('queryUserDsName').value;
            
            if (!dsName) {
                showResult('queryUsersResult', false, '请填写数据源名称');
                return;
            }
            
            fetch(baseUrl + '/api/datasource/' + encodeURIComponent(dsName) + '/users')
            .then(response => response.json())
            .then(data => {
                let message = '用户列表: \n';
                if (data.length > 0) {
                    data.forEach(user => {
                        message += '- ID: ' + user.id + ', 姓名: ' + user.name + ', 邮箱: ' + user.email + '\n';
                    });
                } else {
                    message += '无用户\n';
                }
                showResult('queryUsersResult', true, message);
            })
            .catch(error => {
                showResult('queryUsersResult', false, '查询用户失败: ' + error);
            });
        }

        // 添加Redis集群
        function addRedis(event) {
            event.preventDefault();
            
            const dsName = document.getElementById('redisDsName').value;
            const host = document.getElementById('redisHost').value;
            const port = document.getElementById('redisPort').value;
            
            if (!dsName || !host || !port) {
                showResult('addRedisResult', false, '请填写所有字段');
                return;
            }
            
            const params = new URLSearchParams();
            params.append('dsName', dsName);
            params.append('redisHost', host);
            params.append('redisPort', port);
            
            fetch(baseUrl + '/api/datasource/redis/add', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
                body: params
            })
            .then(response => response.json())
            .then(data => {
                showResult('addRedisResult', data.success, data.message);
                if (data.success) {
                    document.getElementById('addRedisForm').reset();
                }
            })
            .catch(error => {
                showResult('addRedisResult', false, '添加Redis集群失败: ' + error);
            });
        }

        // 设置Redis键值
        function setRedisValue() {
            const dsName = document.getElementById('redisOpsDsName').value;
            const key = document.getElementById('redisKey').value;
            const value = document.getElementById('redisValue').value;
            
            if (!dsName || !key) {
                showResult('redisOperationResult', false, '请填写数据源名称和键');
                return;
            }
            
            const params = new URLSearchParams();
            params.append('key', key);
            if (value) {
                params.append('value', value);
            }
            
            fetch(baseUrl + '/api/datasource/' + encodeURIComponent(dsName) + '/redis/set', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
                body: params
            })
            .then(response => response.json())
            .then(data => {
                showResult('redisOperationResult', data.success, data.message);
            })
            .catch(error => {
                showResult('redisOperationResult', false, '设置Redis键值失败: ' + error);
            });
        }

        // 获取Redis值
        function getRedisValue() {
            const dsName = document.getElementById('redisOpsDsName').value;
            const key = document.getElementById('redisKey').value;
            
            if (!dsName || !key) {
                showResult('redisOperationResult', false, '请填写数据源名称和键');
                return;
            }
            
            fetch(baseUrl + '/api/datasource/' + encodeURIComponent(dsName) + '/redis/get?key=' + encodeURIComponent(key))
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showResult('redisOperationResult', true, '键 "' + key + '" 的值为: ' + data.value);
                } else {
                    showResult('redisOperationResult', false, data.message);
                }
            })
            .catch(error => {
                showResult('redisOperationResult', false, '获取Redis值失败: ' + error);
            });
        }

        // 查询Redis集群列表
        function listRedisClusters() {
            fetch(baseUrl + '/api/datasource/redis/list')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    let message = 'Redis集群列表: \n';
                    if (data.redisClusters && data.redisClusters.length > 0) {
                        data.redisClusters.forEach(cluster => {
                            message += '- ' + cluster + '\n';
                        });
                    } else {
                        message += '无Redis集群\n';
                    }
                    showResult('redisOperationResult', true, message);
                } else {
                    showResult('redisOperationResult', false, data.message);
                }
            })
            .catch(error => {
                showResult('redisOperationResult', false, '查询Redis集群列表失败: ' + error);
            });
        }
    </script>
</body>
</html>